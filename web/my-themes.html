<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ í…Œë§ˆ - Thema Signal</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-top">
                <div>
                    <h1 class="logo">â­ ë‚´ í…Œë§ˆ</h1>
                    <p class="tagline">ë‚˜ë§Œì˜ í…Œë§ˆë¥¼ ë§Œë“¤ê³  ì¶”ì í•˜ì„¸ìš”</p>
                </div>
                <a href="index.html" class="settings-btn" title="ë©”ì¸ìœ¼ë¡œ">
                    ğŸ 
                </a>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- ë‚´ í…Œë§ˆ ì¶”ê°€ ë²„íŠ¼ -->
        <div class="my-theme-actions">
            <button class="btn-add-theme" id="btnAddTheme">
                + ìƒˆ í…Œë§ˆ ë§Œë“¤ê¸°
            </button>
        </div>

        <!-- ë‚´ í…Œë§ˆ ëª©ë¡ -->
        <section class="my-theme-list" id="myThemeList">
            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </section>

        <!-- í…Œë§ˆ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
        <div class="modal" id="themeModal">
            <div class="modal-content modal-small">
                <button class="modal-close" id="modalClose">&times;</button>
                <div class="modal-header">
                    <h3 id="modalTitle">ìƒˆ í…Œë§ˆ ë§Œë“¤ê¸°</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>í…Œë§ˆ ì´ë¦„</label>
                        <input type="text" id="themeName" placeholder="ì˜ˆ: AIë°˜ë„ì²´" maxlength="30">
                    </div>
                    <div class="form-group">
                        <label>ì¢…ëª© ì¶”ê°€</label>
                        <div class="stock-search">
                            <input type="text" id="stockSearch" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰">
                            <div class="stock-search-results" id="stockSearchResults"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì„ íƒëœ ì¢…ëª© <span id="stockCount">(0ê°œ)</span></label>
                        <div class="selected-stocks" id="selectedStocks">
                            <p class="empty-msg">ì¢…ëª©ì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" id="btnCancel">ì·¨ì†Œ</button>
                    <button class="btn-save" id="btnSave">ì €ì¥</button>
                </div>
            </div>
        </div>

        <!-- í…Œë§ˆ ìƒì„¸ ëª¨ë‹¬ -->
        <div class="modal" id="detailModal">
            <div class="modal-content">
                <button class="modal-close" id="detailModalClose">&times;</button>
                <div id="themeDetail">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>âš ï¸ íˆ¬ì ì°¸ê³ ìš© ì •ë³´ì´ë©°, íˆ¬ì íŒë‹¨ì˜ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </footer>

    <script src="data.js"></script>
    <script>
        // ë‚´ í…Œë§ˆ ë°ì´í„° (localStorage ì €ì¥)
        let myThemes = [];
        let editingThemeId = null;
        let selectedStockCodes = [];

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            const success = await loadAllData();
            if (success) {
                loadMyThemes();
                renderMyThemes();
                setupEventListeners();
            }
        });

        // ë‚´ í…Œë§ˆ ë¡œë“œ
        function loadMyThemes() {
            const saved = localStorage.getItem('myThemes');
            myThemes = saved ? JSON.parse(saved) : [];
        }

        // ë‚´ í…Œë§ˆ ì €ì¥
        function saveMyThemes() {
            localStorage.setItem('myThemes', JSON.stringify(myThemes));
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function setupEventListeners() {
            // ìƒˆ í…Œë§ˆ ë²„íŠ¼
            document.getElementById('btnAddTheme').addEventListener('click', () => {
                openThemeModal();
            });

            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('modalClose').addEventListener('click', closeThemeModal);
            document.getElementById('btnCancel').addEventListener('click', closeThemeModal);
            document.getElementById('detailModalClose').addEventListener('click', closeDetailModal);

            // ëª¨ë‹¬ ë°°ê²½ í´ë¦­
            document.getElementById('themeModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) closeThemeModal();
            });
            document.getElementById('detailModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) closeDetailModal();
            });

            // ì €ì¥ ë²„íŠ¼
            document.getElementById('btnSave').addEventListener('click', saveTheme);

            // ì¢…ëª© ê²€ìƒ‰
            let searchTimeout;
            document.getElementById('stockSearch').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => searchStocks(e.target.value), 200);
            });

            // ESC í‚¤
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeThemeModal();
                    closeDetailModal();
                }
            });
        }

        // í…Œë§ˆ ëª¨ë‹¬ ì—´ê¸°
        function openThemeModal(themeId = null) {
            editingThemeId = themeId;
            selectedStockCodes = [];

            if (themeId) {
                const theme = myThemes.find(t => t.id === themeId);
                document.getElementById('modalTitle').textContent = 'í…Œë§ˆ ìˆ˜ì •';
                document.getElementById('themeName').value = theme.name;
                selectedStockCodes = [...theme.stocks];
            } else {
                document.getElementById('modalTitle').textContent = 'ìƒˆ í…Œë§ˆ ë§Œë“¤ê¸°';
                document.getElementById('themeName').value = '';
            }

            renderSelectedStocks();
            document.getElementById('stockSearch').value = '';
            document.getElementById('stockSearchResults').innerHTML = '';
            document.getElementById('themeModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // í…Œë§ˆ ëª¨ë‹¬ ë‹«ê¸°
        function closeThemeModal() {
            document.getElementById('themeModal').classList.remove('active');
            document.body.style.overflow = '';
            editingThemeId = null;
            selectedStockCodes = [];
        }

        // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ì¢…ëª© ê²€ìƒ‰
        function searchStocks(query) {
            const resultsEl = document.getElementById('stockSearchResults');
            if (!query || query.length < 1) {
                resultsEl.innerHTML = '';
                return;
            }

            const q = query.toLowerCase();
            const matches = Object.entries(DATA.stocks)
                .filter(([code, info]) =>
                    code.includes(q) || info.name.toLowerCase().includes(q)
                )
                .slice(0, 10);

            if (matches.length === 0) {
                resultsEl.innerHTML = '<div class="search-no-result">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
                return;
            }

            resultsEl.innerHTML = matches.map(([code, info]) => `
                <div class="search-result-item ${selectedStockCodes.includes(code) ? 'selected' : ''}"
                     data-code="${code}">
                    <span class="stock-name">${info.name}</span>
                    <span class="stock-code">${code}</span>
                    ${selectedStockCodes.includes(code) ? '<span class="check">âœ“</span>' : ''}
                </div>
            `).join('');

            // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­
            resultsEl.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const code = item.dataset.code;
                    if (selectedStockCodes.includes(code)) {
                        selectedStockCodes = selectedStockCodes.filter(c => c !== code);
                    } else {
                        selectedStockCodes.push(code);
                    }
                    searchStocks(document.getElementById('stockSearch').value);
                    renderSelectedStocks();
                });
            });
        }

        // ì„ íƒëœ ì¢…ëª© ë Œë”ë§
        function renderSelectedStocks() {
            const container = document.getElementById('selectedStocks');
            document.getElementById('stockCount').textContent = `(${selectedStockCodes.length}ê°œ)`;

            if (selectedStockCodes.length === 0) {
                container.innerHTML = '<p class="empty-msg">ì¢…ëª©ì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</p>';
                return;
            }

            container.innerHTML = selectedStockCodes.map(code => {
                const stock = DATA.stocks[code] || { name: code };
                return `
                    <div class="selected-stock-item">
                        <span>${stock.name}</span>
                        <button class="btn-remove" data-code="${code}">&times;</button>
                    </div>
                `;
            }).join('');

            // ì‚­ì œ ë²„íŠ¼
            container.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', () => {
                    const code = btn.dataset.code;
                    selectedStockCodes = selectedStockCodes.filter(c => c !== code);
                    renderSelectedStocks();
                    searchStocks(document.getElementById('stockSearch').value);
                });
            });
        }

        // í…Œë§ˆ ì €ì¥
        function saveTheme() {
            const name = document.getElementById('themeName').value.trim();

            if (!name) {
                alert('í…Œë§ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            if (selectedStockCodes.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¢…ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”');
                return;
            }

            if (editingThemeId) {
                // ìˆ˜ì •
                const idx = myThemes.findIndex(t => t.id === editingThemeId);
                if (idx !== -1) {
                    myThemes[idx].name = name;
                    myThemes[idx].stocks = [...selectedStockCodes];
                }
            } else {
                // ìƒˆë¡œ ì¶”ê°€
                myThemes.push({
                    id: 'my_' + Date.now(),
                    name,
                    stocks: [...selectedStockCodes],
                    createdAt: new Date().toISOString()
                });
            }

            saveMyThemes();
            renderMyThemes();
            closeThemeModal();
        }

        // í…Œë§ˆ ì‚­ì œ
        function deleteTheme(themeId) {
            if (!confirm('ì´ í…Œë§ˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            myThemes = myThemes.filter(t => t.id !== themeId);
            saveMyThemes();
            renderMyThemes();
        }

        // ë‚´ í…Œë§ˆ ëª©ë¡ ë Œë”ë§
        function renderMyThemes() {
            const container = document.getElementById('myThemeList');

            if (myThemes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>ì•„ì§ ë§Œë“  í…Œë§ˆê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p>ìœ„ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‚˜ë§Œì˜ í…Œë§ˆë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = myThemes.map(theme => {
                // í…Œë§ˆ ì§€í‘œ ê³„ì‚°
                const metrics = calcMyThemeMetrics(theme);
                const stageClass = getStageClass(metrics.stage);

                // TOP 3 ì¢…ëª©
                const top3 = metrics.stockReturns
                    .sort((a, b) => b.return_3w - a.return_3w)
                    .slice(0, 3);

                return `
                    <div class="my-theme-card ${stageClass}" data-theme-id="${theme.id}">
                        <div class="my-theme-header">
                            <div class="my-theme-name">${theme.name}</div>
                            <div class="my-theme-actions-inline">
                                <button class="btn-edit" data-id="${theme.id}" title="ìˆ˜ì •">âœï¸</button>
                                <button class="btn-delete" data-id="${theme.id}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="my-theme-return ${metrics.return_3w >= 0 ? 'positive' : 'negative'}">
                            ${metrics.return_3w >= 0 ? '+' : ''}${metrics.return_3w.toFixed(1)}%
                            <span class="return-label">3ì£¼ ìˆ˜ìµë¥ </span>
                        </div>
                        <div class="my-theme-badges">
                            <span class="badge stage-badge ${stageClass}">${metrics.stage}</span>
                            <span class="badge">${theme.stocks.length}ì¢…ëª©</span>
                            <span class="badge spread-badge">í™•ì‚° ${metrics.spread_3w}%</span>
                        </div>
                        <div class="my-theme-top3">
                            ${top3.map((item, idx) => `
                                <div class="top-stock-item">
                                    <span class="top-stock-rank rank-${idx + 1}">${idx === 0 ? 'ğŸ‘‘' : idx + 1}</span>
                                    <span class="top-stock-name">${item.name}</span>
                                    <span class="top-stock-return ${item.return_3w >= 0 ? 'positive' : 'negative'}">
                                        ${item.return_3w >= 0 ? '+' : ''}${item.return_3w.toFixed(1)}%
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn-detail" data-id="${theme.id}">ìƒì„¸ë³´ê¸°</button>
                    </div>
                `;
            }).join('');

            // ì´ë²¤íŠ¸ ë°”ì¸ë”©
            container.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openThemeModal(btn.dataset.id);
                });
            });
            container.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTheme(btn.dataset.id);
                });
            });
            container.querySelectorAll('.btn-detail').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDetailModal(btn.dataset.id);
                });
            });
        }

        // ë‚´ í…Œë§ˆ ì§€í‘œ ê³„ì‚°
        function calcMyThemeMetrics(theme) {
            const stockReturns = theme.stocks.map(code => {
                const stock = DATA.stocks[code] || { name: code };
                return {
                    code,
                    name: stock.name,
                    return_3w: calcReturn(code, 3) || 0,
                    return_6w: calcReturn(code, 6) || 0,
                    return_9w: calcReturn(code, 9) || 0,
                    avg_volume: calcAvgVolume(code)
                };
            });

            // ìƒìœ„ ì¢…ëª© í‰ê·  ìˆ˜ìµë¥ 
            const sorted3w = [...stockReturns].sort((a, b) => b.return_3w - a.return_3w);
            const sorted6w = [...stockReturns].sort((a, b) => b.return_6w - a.return_6w);
            const topCount = Math.min(Math.max(3, Math.floor(stockReturns.length / 2)), 5);

            const return_3w = sorted3w.slice(0, topCount).reduce((s, r) => s + r.return_3w, 0) / topCount;
            const return_6w = sorted6w.slice(0, topCount).reduce((s, r) => s + r.return_6w, 0) / topCount;

            // í™•ì‚°ë„
            const spread_3w = Math.round((stockReturns.filter(r => r.return_3w >= 10).length / stockReturns.length) * 100);
            const spread_6w = Math.round((stockReturns.filter(r => r.return_6w >= 15).length / stockReturns.length) * 100);

            // ë‹¨ê³„
            const { stage } = determineStage(return_3w, return_6w, spread_3w, spread_6w);

            return { return_3w, return_6w, spread_3w, spread_6w, stage, stockReturns };
        }

        // ë‹¨ê³„ í´ë˜ìŠ¤
        function getStageClass(stage) {
            switch (stage) {
                case '0ë‹¨ê³„': return 'stage-0';
                case '1ë‹¨ê³„': return 'stage-1';
                case '2ë‹¨ê³„': return 'stage-2';
                case '3ë‹¨ê³„': return 'stage-3';
                case 'ì •ë¦¬': return 'stage-settle';
                case 'ì†Œë©¸': return 'stage-extinct';
                default: return '';
            }
        }

        // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        function openDetailModal(themeId) {
            const theme = myThemes.find(t => t.id === themeId);
            if (!theme) return;

            const metrics = calcMyThemeMetrics(theme);
            const container = document.getElementById('themeDetail');

            container.innerHTML = `
                <div class="detail-header">
                    <h2>â­ ${theme.name}</h2>
                    <div class="detail-return ${metrics.return_3w >= 0 ? 'positive' : 'negative'}">
                        3ì£¼ ìˆ˜ìµë¥ : ${metrics.return_3w >= 0 ? '+' : ''}${metrics.return_3w.toFixed(1)}%
                    </div>
                </div>
                <div class="detail-body">
                    <div class="detail-grid">
                        <div class="detail-card">
                            <h4>ğŸ“Š í™•ì‚°ë„</h4>
                            <div class="spread-bars">
                                <div class="spread-item">
                                    <span>3ì£¼</span>
                                    <div class="spread-bar">
                                        <div class="spread-fill" style="width: ${Math.min(metrics.spread_3w, 100)}%"></div>
                                    </div>
                                    <span>${metrics.spread_3w}%</span>
                                </div>
                                <div class="spread-item">
                                    <span>6ì£¼</span>
                                    <div class="spread-bar">
                                        <div class="spread-fill" style="width: ${Math.min(metrics.spread_6w, 100)}%"></div>
                                    </div>
                                    <span>${metrics.spread_6w}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="detail-card">
                            <h4>ğŸ“‹ í…Œë§ˆ ì •ë³´</h4>
                            <p>ì¢…ëª© ìˆ˜: ${theme.stocks.length}ê°œ</p>
                            <p>3ì£¼ ìˆ˜ìµë¥ : ${metrics.return_3w.toFixed(1)}%</p>
                            <p>6ì£¼ ìˆ˜ìµë¥ : ${metrics.return_6w.toFixed(1)}%</p>
                            <p>ë‹¨ê³„: ${metrics.stage}</p>
                        </div>
                    </div>
                    <div class="detail-card full-width">
                        <h4>ğŸ“ˆ ì¢…ëª©ë³„ í˜„í™©</h4>
                        <table class="stock-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ì¢…ëª©ëª…</th>
                                    <th>3ì£¼</th>
                                    <th>6ì£¼</th>
                                    <th>9ì£¼</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${metrics.stockReturns
                                    .sort((a, b) => b.return_3w - a.return_3w)
                                    .map((item, idx) => `
                                    <tr class="${idx === 0 ? 'leader-row' : ''}">
                                        <td>${idx + 1}</td>
                                        <td>
                                            <span class="stock-name">${item.name}</span>
                                            <span class="stock-code">${item.code}</span>
                                        </td>
                                        <td class="${item.return_3w >= 0 ? 'positive' : 'negative'}">
                                            ${item.return_3w >= 0 ? '+' : ''}${item.return_3w.toFixed(1)}%
                                        </td>
                                        <td class="${item.return_6w >= 0 ? 'positive' : 'negative'}">
                                            ${item.return_6w >= 0 ? '+' : ''}${item.return_6w.toFixed(1)}%
                                        </td>
                                        <td class="${item.return_9w >= 0 ? 'positive' : 'negative'}">
                                            ${item.return_9w >= 0 ? '+' : ''}${item.return_9w.toFixed(1)}%
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    </script>
</body>
</html>
