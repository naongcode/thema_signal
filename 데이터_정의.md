# Thema Signal - 데이터 정의

## 1. 파일 구조

```
web/data/
├── stocks.json           # 종목 기본정보
├── market.json           # 시장 데이터 (시총, 주식수, PER, PBR)
├── financial.json        # 재무 데이터 (매출, 영업이익)
├── themes.json           # 테마 목록 + 종목 매핑
└── prices/
    ├── 2025-01.json      # 월별 가격 데이터 (종가 + 거래대금)
    ├── 2025-02.json
    └── ...
```

---

## 2. 파일별 스키마

### 2.1 stocks.json (종목 기본정보)
```json
{
  "005930": { "name": "삼성전자", "market": "KOSPI" },
  "000660": { "name": "SK하이닉스", "market": "KOSPI" },
  "373220": { "name": "LG에너지솔루션", "market": "KOSPI" }
}
```
- **갱신 주기**: 주 1회
- **용량**: ~260KB (2,600종목)

### 2.2 market.json (시장 데이터)
```json
{
  "date": "2025-01-20",
  "data": {
    "005930": {
      "market_cap": 420000000000000,
      "shares": 5969782550,
      "per": 12.5,
      "pbr": 1.2
    },
    "000660": {
      "market_cap": 125000000000000,
      "shares": 728002365,
      "per": 8.3,
      "pbr": 1.5
    }
  }
}
```
- **갱신 주기**: 일 1회
- **용량**: ~400KB

### 2.3 financial.json (재무 데이터)
```json
{
  "quarter": "2024-Q3",
  "data": {
    "005930": {
      "revenue": 79000000000000,
      "operating_profit": 9180000000000
    },
    "000660": {
      "revenue": 17200000000000,
      "operating_profit": 5100000000000
    }
  }
}
```
- **갱신 주기**: 분기 1회
- **용량**: ~260KB

### 2.4 themes.json (테마 매핑)
```json
{
  "themes": [
    {
      "id": "T001",
      "name": "2차전지",
      "stocks": ["373220", "247540", "086520", "003670"]
    },
    {
      "id": "T002",
      "name": "AI반도체",
      "stocks": ["000660", "005930", "042700"]
    }
  ]
}
```
- **갱신 주기**: 주 1회
- **용량**: ~50KB

### 2.5 prices/YYYY-MM.json (월별 가격)
```json
{
  "005930": {
    "2025-01-20": { "close": 71000, "value": 850000000000 },
    "2025-01-17": { "close": 71500, "value": 920000000000 },
    "2025-01-16": { "close": 70800, "value": 780000000000 }
  },
  "000660": {
    "2025-01-20": { "close": 185000, "value": 620000000000 },
    "2025-01-17": { "close": 183500, "value": 580000000000 }
  }
}
```
- **갱신 주기**: 일 1회 (해당 월 파일에 추가)
- **용량**: ~2.8MB/월

---

## 3. 용량 요약

| 파일 | 용량 | 갱신 주기 |
|------|------|----------|
| stocks.json | ~260KB | 주 1회 |
| market.json | ~400KB | 일 1회 |
| financial.json | ~260KB | 분기 1회 |
| themes.json | ~50KB | 주 1회 |
| prices/월별 | ~2.8MB/월 | 일 1회 |

- **초기 로드** (최근 3개월): ~9MB
- **연간 누적**: ~34MB/년

---

## 4. 데이터 소스

| 데이터 | 소스 | 비고 |
|--------|------|------|
| 종목 기본정보 | 키움 API / KRX | |
| 종가, 거래대금 | 키움 API | 기존 crawler 활용 |
| 시총, 주식수, PER, PBR | 키움 API / 네이버 금융 | |
| 매출, 영업이익 | 네이버 금융 / DART API | |
| 테마 매핑 | 키움 API | 기존 crawler 활용 |

---

## 5. 계산 지표 (캐싱/저장 대상)

### 5.1 테마별 지표 (ThemeMetric)
| 필드 | 타입 | 설명 |
|------|------|------|
| id | PK | ID |
| theme_id | FK | 테마 ID |
| date | date | 기준일 |
| return_3w | decimal | 3주 수익률 (상위 3~5개 평균) |
| return_6w | decimal | 6주 수익률 |
| return_9w | decimal | 9주 수익률 |
| spread_3w | decimal | 3주 확산도 (%) |
| spread_6w | decimal | 6주 확산도 (%) |
| rank_3w | int | 3주 기준 테마 순위 |
| rank_6w | int | 6주 기준 테마 순위 |
| rank_9w | int | 9주 기준 테마 순위 |
| stage | string | 현재 단계 (0주목/1초기/2확산/3과열/정리/소멸) |
| leader_3w_stock_id | FK | 3주 대장주 |
| leader_6w_stock_id | FK | 6주 대장주 |
| leader_9w_stock_id | FK | 9주 대장주 |
| leader_volume_stock_id | FK | 거래대금 대장주 |

### 5.2 종목별 지표 (StockMetric)
| 필드 | 타입 | 설명 |
|------|------|------|
| id | PK | ID |
| stock_id | FK | 종목 ID |
| date | date | 기준일 |
| return_3w | decimal | 3주 수익률 |
| return_6w | decimal | 6주 수익률 |
| return_9w | decimal | 9주 수익률 |
| avg_volume_1w | bigint | 1주 평균 거래대금 |

---

## 6. 계산 로직

### 6.1 수익률 계산
```
N주 수익률 = (오늘 종가 - N주 전 종가) / N주 전 종가 × 100
```

### 6.2 테마 수익률 계산
```
테마 N주 수익률 = 테마 내 종목들의 N주 수익률 중 상위 3~5개 평균
```

### 6.3 확산도 계산
```
3주 확산도 = (3주 수익률 10% 이상 종목 수) / (테마 내 전체 종목 수) × 100
6주 확산도 = (6주 수익률 15% 이상 종목 수) / (테마 내 전체 종목 수) × 100
```

### 6.4 테마 순위 계산
```
전체 테마를 N주 수익률 기준 내림차순 정렬 → 순위 부여
```

### 6.5 단계 판정
```
IF 꺾임 판정 = TRUE
  IF 이전 단계 in (0, 1) → 소멸
  ELSE → 정리
ELSE
  IF 상승 종목 수 = 1~2개 → 0단계 (주목)
  ELSE IF 확산도 < 20% → 1단계 (초기)
  ELSE IF 확산도 < 50% → 2단계 (확산)
  ELSE → 3단계 (과열)
```

### 6.6 꺾임 판정
```
꺾임 = 다음 중 하나 이상 충족
  1) 전일 대비 테마 수익률 -3%p 이상 하락
  2) 최근 고점 대비 -5%p 이상 하락
  3) 2일 연속 테마 수익률 감소
```

---

## 7. 갱신 주기

| 데이터 | 갱신 주기 | 시점 |
|--------|----------|------|
| prices/월별.json | 일 1회 | 장 마감 후 (15:30 이후) |
| market.json | 일 1회 | 장 마감 후 |
| financial.json | 분기 1회 | 실적 발표 후 |
| stocks.json | 주 1회 | 주말 |
| themes.json | 주 1회 | 주말 |
| 종목별 지표 | 일 1회 | 일봉 데이터 갱신 후 |
| 테마별 지표 | 일 1회 | 종목별 지표 갱신 후 |
