# Thema Signal - 계산 로직 명세

## 현재 상태
- 모든 데이터 하드코딩 (data.js)
- 계산 로직 없음

---

## 1. 종목별 지표 계산

### 1.1 수익률 계산
```
N주 수익률 = (오늘 종가 - N주 전 종가) / N주 전 종가 × 100

- return_3w: 3주(15 거래일) 수익률
- return_6w: 6주(30 거래일) 수익률
- return_9w: 9주(45 거래일) 수익률
```

### 1.2 거래대금 계산
```
avg_volume_1w = 최근 5거래일 거래대금 평균
```

### 입력 데이터
- 일봉 데이터 (DailyPrice): date, close, trading_value

---

## 2. 테마별 지표 계산

### 2.1 테마 수익률
```
테마 N주 수익률 = 테마 내 종목들의 N주 수익률 중 상위 3~5개 평균

- return_3w: 상위 3~5개 종목의 3주 수익률 평균
- return_6w: 상위 3~5개 종목의 6주 수익률 평균
- return_9w: 상위 3~5개 종목의 9주 수익률 평균
```

### 2.2 확산도
```
3주 확산도 = (3주 수익률 10% 이상 종목 수) / (테마 내 전체 종목 수) × 100
6주 확산도 = (6주 수익률 15% 이상 종목 수) / (테마 내 전체 종목 수) × 100

- spread_3w: 3주 확산도 (%)
- spread_6w: 6주 확산도 (%)
```

### 2.3 대장주
```
leader_3w = 3주 수익률 1위 종목
leader_6w = 6주 수익률 1위 종목
leader_9w = 9주 수익률 1위 종목
leader_volume = 1주 평균 거래대금 1위 종목
```

### 2.4 테마 순위
```
전체 테마를 N주 수익률 기준 내림차순 정렬 → 순위 부여

- rank_3w: 3주 수익률 기준 순위
- rank_6w: 6주 수익률 기준 순위
- rank_9w: 9주 수익률 기준 순위
```

---

## 3. 단계 판정

### 3.1 상승 흐름 (꺾임 없을 때)
```
IF 상승 종목 수 = 1~2개 → 0단계 (주목)
ELSE IF 확산도 < 20%    → 1단계 (초기)
ELSE IF 확산도 < 50%    → 2단계 (확산)
ELSE                    → 3단계 (과열)

* 확산도 = max(spread_3w, spread_6w)
* 상승 종목 = 3주 수익률 10% 이상 OR 6주 수익률 15% 이상
```

### 3.2 꺾임 판정
```
꺾임 = 다음 중 하나 이상 충족:
  1) 전일 대비 테마 수익률 -3%p 이상 하락
  2) 최근 고점 대비 -5%p 이상 하락
  3) 2일 연속 테마 수익률 감소
```

### 3.3 하락 전환 (꺾임 판정 시)
```
IF 이전 단계 = 0단계 or 1단계 → 소멸
ELSE                          → 정리
```

### 3.4 단계 라벨
| stage | stageLabel |
|-------|------------|
| 0단계 | 주목 |
| 1단계 | 초기 |
| 2단계 | 확산 |
| 3단계 | 과열 |
| 정리 | 정리 |
| 소멸 | 소멸 |

---

## 4. 히스토리 자동 기록

### 4.1 기록 시점
- 매일 장 마감 후 단계 계산
- 이전 단계 ≠ 현재 단계 → 히스토리 추가

### 4.2 이벤트 메시지 자동 생성
```
0단계 진입: "{대장주} 단독 상승"
1단계 진입: "{상승종목수}개 종목 상승, 테마 형성 시작"
2단계 진입: "확산도 {spread}% 돌파"
3단계 진입: "확산도 {spread}% 돌파, 과열 구간"
정리 진입: "고점 대비 -{x}%p 하락, 차익실현 구간"
소멸 진입: "테마 형성 실패"
```

---

## 5. 테마 상승 감지 (알림용)

### 5.1 감지 조건
```
테마 상승 신호 = 다음 중 하나 충족:
  - 3주 수익률 >= 20% (상위 3~5개 평균)
  - 6주 수익률 >= 30% (상위 3~5개 평균)
```

### 5.2 알림 발송
- 조건 최초 충족 시 1회 알림
- 단계 변화 시 알림 (1→2, 2→3, 3→정리 등)

---

## 6. 파라미터 (조정 가능)

| 파라미터 | 기본값 | 설명 |
|---------|--------|------|
| TOP_N_STOCKS | 5 | 테마 수익률 계산에 사용할 상위 종목 수 |
| SPREAD_THRESHOLD_3W | 10 | 3주 확산도 계산 기준 수익률 (%) |
| SPREAD_THRESHOLD_6W | 15 | 6주 확산도 계산 기준 수익률 (%) |
| STAGE_1_THRESHOLD | 20 | 1→2단계 확산도 기준 (%) |
| STAGE_2_THRESHOLD | 50 | 2→3단계 확산도 기준 (%) |
| DECLINE_DAY_THRESHOLD | 3 | 전일 대비 꺾임 기준 (%p) |
| DECLINE_PEAK_THRESHOLD | 5 | 고점 대비 꺾임 기준 (%p) |
| THEME_SIGNAL_3W | 20 | 테마 상승 신호 3주 기준 (%) |
| THEME_SIGNAL_6W | 30 | 테마 상승 신호 6주 기준 (%) |

---

## 7. 데이터 흐름

```
[일봉 데이터]
    ↓ 장 마감 후 수집
[종목별 지표 계산]
    - 수익률 (3w, 6w, 9w)
    - 거래대금 (1w 평균)
    ↓
[테마별 지표 계산]
    - 테마 수익률
    - 확산도
    - 대장주
    - 순위
    ↓
[단계 판정]
    - 꺾임 체크
    - 단계 결정
    ↓
[히스토리 기록]
    - 단계 변화 시 저장
    ↓
[알림 발송]
    - 테마 상승 신호
    - 단계 변화
```

---

## 8. 구현 위치 (예정)

| 항목 | 위치 | 비고 |
|------|------|------|
| 일봉 수집 | crawlers/kiwoom/price_crawler.py | 기존 코드 |
| 지표 계산 | backend/calculator.py | 신규 |
| 단계 판정 | backend/stage_detector.py | 신규 |
| 히스토리 | backend/history_recorder.py | 신규 |
| 스케줄러 | crawlers/scheduler.py | 기존 코드 확장 |
| API | backend/api.py | 신규 (웹에 데이터 제공) |
